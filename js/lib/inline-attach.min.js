/*! inline-attach - v1.3.2 - 2014-11-07 */
(function(e,a){"use strict";function t(){for(var e={},a=arguments.length-1;a>=0;a--){var t=arguments[a];for(var n in t)e[n]=t[n]}return e}a.inlineAttach=function(e,n){function r(e,a){return(e+"\n\n[[D]]"+a).replace(/(\n{2,})\[\[D\]\]/,"\n\n").replace(/^(\n*)/,"")}var o,i=t(e,inlineAttach.defaults),l=n,s="{filename}",d=this;this.uploadFile=function(e){var a=new FormData,t=new XMLHttpRequest,n="png";if(e.name){var r=e.name.match(/\.(.+)$/);r&&(n=r[1])}if(i.addFileBeforeExtraParameters&&a.append(i.uploadFieldName,e,"image-"+Date.now()+"."+n),"object"==typeof i.extraParams)for(var o in i.extraParams)i.extraParams.hasOwnProperty(o)&&a.append(o,i.extraParams[o]);if(i.addFileBeforeExtraParameters||a.append(i.uploadFieldName,e,"image-"+Date.now()+"."+n),t.open(i.uploadMethod,i.uploadUrl),"object"==typeof i.extraHeaders)for(var l in i.extraHeaders)i.extraHeaders.hasOwnProperty(l)&&t.setRequestHeader(l,i.extraHeaders[l]);t.onload=function(){if(200===t.status||201===t.status){var e=d.parseResponse(t);d.onUploadedFile(e)}else d.onErrorUploading()},t.send(a)},this.parseResponse=function(e){return i.customResponseParser.call(this,e)||JSON.parse(e.responseText)},this.isAllowedFile=function(e){return i.allowedTypes.indexOf(e.type)>=0},this.onUploadedFile=function(e){var a,t=i.onUploadedFile.call(this,e);if(i.dataProcessor&&(e=i.dataProcessor.call(this,e)),a=e[i.downloadFieldName],t!==!1&&a){var n=l.getValue().replace(o,i.urlText.replace(s,a));l.setValue(n)}},this.customUploadHandler=function(e){return i.customUploadHandler.call(this,e)},this.onErrorUploading=function(){var e=l.getValue().replace(o,"");l.setValue(e),i.customErrorHandler.call(this)&&a.alert(i.errorText)},this.onReceivedFile=function(e){var a=i.onReceivedFile.call(this,e);a!==!1&&(o=i.progressText,l.setValue(r(l.getValue(),o)))},this.onPaste=function(e){var a,t=!1,n=e.clipboardData;if("object"==typeof n){a=n.items||n.files||[];for(var r=0;a.length>r;r++){var o=a[r];d.isAllowedFile(o)&&(t=!0,this.onReceivedFile(o.getAsFile()),this.customUploadHandler(o.getAsFile())&&this.uploadFile(o.getAsFile()))}}return t},this.onDrop=function(e){for(var a=!1,t=0;e.dataTransfer.files.length>t;t++){var n=e.dataTransfer.files[t];d.isAllowedFile(n)&&(a=!0,this.onReceivedFile(n),this.customUploadHandler(n)&&this.uploadFile(n))}return a}},a.inlineAttach.Editor=function(e){var a=e;return{getValue:function(){return a.value},setValue:function(e){a.value=e}}},a.inlineAttach.defaults={uploadUrl:"upload_attachment.php",uploadMethod:"POST",uploadFieldName:"file",addFileBeforeExtraParameters:!0,downloadFieldName:"filename",allowedTypes:["image/jpeg","image/png","image/jpg","image/gif"],progressText:"![Uploading file...]()",urlText:"![file]({filename})",errorText:"Error uploading file",extraParams:{},extraHeaders:{},onReceivedFile:function(){},customUploadHandler:function(){return!0},customErrorHandler:function(){return!0},customResponseParser:function(){return null},onUploadedFile:function(){}},a.inlineAttach.attachToInput=function(e,a){a=a||{};var t=new inlineAttach.Editor(e),n=new inlineAttach(a,t);e.addEventListener("paste",function(e){n.onPaste(e)},!1),e.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),n.onDrop(e)},!1),e.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1)}})(document,window);